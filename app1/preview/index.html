<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math + Markdown 预览</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { margin: 0; padding: 0; background: #111; }
    body { color: #eaeaea; font-family: -apple-system, system-ui, Segoe UI, Roboto, PingFang SC, Noto Sans SC, Microsoft YaHei, "Helvetica Neue", Arial, sans-serif; font-size: 16px; line-height: 1.5; }
    #content { white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; width: 100%; line-height: 1.55; padding: 16px; }
    #content, .katex-display { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .katex-display { margin: 0.8em 0; }
    /* 行内 code 与正文统一外观：透明背景、继承颜色、正常字重、去额外内边距 */
    code { background: transparent !important; color: inherit !important; font-weight: 400; padding: 0; border-radius: 0; }
    a { color: #7aa2f7; text-decoration: underline; }
    ul, ol { margin: .25em 0; padding-left: 1.25em; }
    blockquote { border-left: 3px solid rgba(127,127,127,.35); margin: .5em 0; padding: .25em .75em; opacity: .95; }
    h1,h2,h3,h4,h5,h6 { margin: .8em 0 .4em; font-weight: 700; }
    h1{ font-size: 1.6em; } h2{ font-size: 1.4em; } h3{ font-size: 1.25em; }
    h4{ font-size: 1.15em; } h5{ font-size: 1.05em; } h6{ font-size: 1em; opacity:.95; }
  </style>
</head>
<body>
  <div id="content"></div>
  <script>
    function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function simpleMarkdownToHtml(src){
      function protectMathSegments(s){
        const segs = [];
        let out = '';
        let i = 0;
        function pushToken(seg){ const token = '§MATH' + segs.length + '§'; segs.push(seg); out += token; }
        while(i < s.length){
          if (s[i] === '\\'){
            const two = s.substr(i,2);
            if (two === '\\('){ const end = s.indexOf('\\)', i+2); if (end !== -1){ pushToken(s.substring(i, end+2)); i = end+2; continue; } }
            else if (two === '\\['){ const end = s.indexOf('\\]', i+2); if (end !== -1){ pushToken(s.substring(i, end+2)); i = end+2; continue; } }
            out += s[i++]; continue;
          }
          if (s[i] === '$'){
            const isDouble = (i+1 < s.length && s[i+1] === '$');
            if (isDouble){ const end = s.indexOf('$$', i+2); if (end !== -1){ pushToken(s.substring(i, end+2)); i = end+2; continue; } }
            else { let j = i+1, found = -1; while(j < s.length){ if (s[j] === '$' && s[j-1] !== '\\'){ found = j; break; } j++; } if (found !== -1){ pushToken(s.substring(i, found+1)); i = found+1; continue; } }
          }
          out += s[i++];
        }
        return { text: out, segs };
      }
      function restoreMath(text, segs){ for (let k=0;k<segs.length;k++){ text = text.replace('§MATH'+k+'§', segs[k]); } return text; }
      let protectedObj = protectMathSegments(src);
      let s = escapeHtml(protectedObj.text);
      s = s.replace(/`([^`]+?)`/g,'<code>$1</code>');
      s = s.replace(/\[([^\]]+)\]\(([^)\s]+)\)/g,'<a href=\"$2\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>');
      // 支持 ASCII 与全角星号的加粗/斜体
      s = s.replace(/(?:\*{2}|＊{2})([\s\S]+?)(?:\*{2}|＊{2})/g,'<strong>$1</strong>');
      s = s.replace(/(^|[^*＊])(?:\*|＊)([^*＊\n]+)(?:\*|＊)(?![*＊])/g,'$1<em>$2</em>');
      const lines = s.split(/\n/);
      let out = '';
      let inUl = false, inOl = false, inQuote = false;
      function closeAll(){ if(inUl){ out += '</ul>'; inUl=false; } if(inOl){ out += '</ol>'; inOl=false; } if(inQuote){ out += '</blockquote>'; inQuote=false; } }
      for (let i=0;i<lines.length;i++){
        const line = lines[i];
        if (/^\s*(?:-{3,}|\*{3,}|_{3,})\s*$/.test(line)) { closeAll(); out += '<hr/>'; continue; }
        let hm = line.match(/^\s{0,3}(#{1,6})\s+(.+)$/);
        if (hm){ closeAll(); const level = hm[1].length; const text = hm[2]; out += `<h${level}>${text}</h${level}>`; continue; }
        let qm = line.match(/^\s{0,3}>\s?(.*)$/);
        if (qm){ if(!inQuote){ closeAll(); out += '<blockquote>'; inQuote = true; } out += (qm[1] || '') + (i<lines.length-1?'\n':''); continue; }
        else if (inQuote && line.trim() === '') { out += '\n'; continue; }
        else if (inQuote) { out += '</blockquote>'; inQuote = false; }
        let om = line.match(/^\s{0,3}(\d+)\.\s+(.+)$/);
        if (om){ if(!inOl){ closeAll(); out += '<ol>'; inOl = true; } out += `<li>${om[2]}</li>`; continue; }
        let um = line.match(/^\s{0,3}(?:[-*+])\s+(.+)$/);
        if (um){ if(!inUl){ closeAll(); out += '<ul>'; inUl = true; } out += `<li>${um[1]}</li>`; continue; }
        closeAll(); out += line + (i<lines.length-1?'\n':'');
      }
      closeAll();
      out = restoreMath(out, protectedObj.segs);
      return out;
    }
    const demo = `# 一级标题\n\n## 二级标题\n\n- 列表 A\n- 列表 B\n\n1. 第一项\n2. 第二项\n\n> 这里是引用\n\n内联代码: \`code\`，以及链接 [KaTeX](https://katex.org).\n\n行内数学: $e^{i\\pi}+1=0$\n\n块级数学: \n\n$$\\int_0^1 x^2\\,dx = \\frac{1}{3}$$`;
    const container = document.getElementById('content');
    container.innerHTML = simpleMarkdownToHtml(demo);
    renderMathInElement(container, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false},
        {left: '\\[', right: '\\]', display: true}
      ],
      throwOnError: false
    });
  </script>
</body>
</html>